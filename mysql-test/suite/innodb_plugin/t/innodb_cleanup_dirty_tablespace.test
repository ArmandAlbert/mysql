--source include/have_innodb.inc
--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings
SET SQL_WARNINGS=1;

let $MYSQLD_DATADIR= `SELECT @@datadir`;

--echo #
--echo # Test restart after clean shutdown
--echo #
create table t1 (a int) engine="innodb";

--echo List files initial
--list_files $MYSQLD_DATADIR/test t1*

--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server 10
--source include/wait_until_disconnected.inc

--remove_file $MYSQLD_DATADIR/test/t1.ibd

--enable_reconnect
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc

--echo List files after restart
--list_files $MYSQLD_DATADIR/test t1*
show tables;

#
# As the cleanup (or is it the test??) function really doesn't work...
#   i.e leave the table inside innodb data dictionary it will be 
#       found below (on second restart) and emit this warning...
#
#   Suppress it for now...
#
call mtr.add_suppression("Error trying to clean up dirty tablespace");

--echo #
--echo # Test restart after non-clean shutdown
--echo #
create table t2 (a int) engine="innodb";

--echo List files initial
--list_files $MYSQLD_DATADIR/test t2*

--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server 1
--source include/wait_until_disconnected.inc

--remove_file $MYSQLD_DATADIR/test/t2.ibd

--enable_reconnect
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc

--echo List files after restart
--list_files $MYSQLD_DATADIR/test t2*
show tables;
