# Test the httpd server:
#  check the main page for master and slave
#  check the /var
#  check the /var?var=
#  check the /health

--source include/master-slave.inc

echo Test the main page;

echo Check the master table headers;
exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT"
    | egrep " <th>.*</th>" | sed "s/<[^>]*>/ /g";

echo Check the binary log on the master;
exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT"
    | grep "master-bin"
    | sed -r -e "s/<[^>]*>/ /g" -e "s/\.[0-9]+//";

echo Check the slave connection on the master;
exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT"
    | grep "Binlog Dump"
    | sed "s/<[^>]*>/ /g";

echo Check the slave table headers;
exec wget -q -O - "0.0.0.0:$SLAVE_HTTP_PORT"
    | egrep " <th>.*</th>" | sed "s/<[^>]*>/ /g"
    | sed "s/<[^>]*>/ /g";

echo Check the binary and relay logs on the slave;
exec wget -q -O - "0.0.0.0:$SLAVE_HTTP_PORT"
    | egrep "master-bin|slave-bin|slave-relay-bin"
    | sed -r -e "s/<[^>]*>/ /g" -e "s/\.[0-9]+ \/ [0-9]+//";

echo Check the connection to the master;
exec wget -q -O - "0.0.0.0:$SLAVE_HTTP_PORT"
    | grep "Waiting for master to send event"
    | sed "s/<[^>]*>/ /g";

echo Check for SQL and IO thread;
exec wget -q -O - "0.0.0.0:$SLAVE_HTTP_PORT"
    | grep "system user"
    | sed "s/<[^>]*>/ /g";

echo Test the /var;
exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/var"
    | egrep "(status_uptime|status_queries|status_questions) "
    | sed "s/[0-9][0-9]*/NUMBER/g";

exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/var?var=";
exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/var?var=:";
exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/var?var=:::";

exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/var?var=status_uptime"
    | sed "s/[0-9][0-9]*/NUMBER/g";

exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/var?var=status_uptime:"
    | sed "s/[0-9][0-9]*/NUMBER/g";

exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/var?var=status_uptime:::"
    | sed "s/[0-9][0-9]*/NUMBER/g";

exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/var?var=status_uptime:status_queries:status_questions"
    | sed "s/[0-9][0-9]*/NUMBER/g";

echo Test the /health;
exec wget -q -O - "0.0.0.0:$MASTER_HTTP_PORT/health";

--source include/rpl_end.inc
